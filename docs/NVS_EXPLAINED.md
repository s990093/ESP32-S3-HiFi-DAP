# NVS å„²å­˜æ©Ÿåˆ¶èªªæ˜

## ğŸ” ä»€éº¼æ˜¯ NVSï¼Ÿ

**NVS** = **Non-Volatile Storage** (éæ®ç™¼æ€§å„²å­˜)

é€™æ˜¯ ESP32 å…§å»ºçš„ä¸€å€‹ç‰¹æ®Š **Flash è¨˜æ†¶é«”åˆ†å€**ï¼Œç”¨ä¾†æ°¸ä¹…å„²å­˜è³‡æ–™ã€‚

### ğŸ“ NVS å­˜åœ¨å“ªè£¡ï¼Ÿ

```
ESP32 Flash Memory (4MB)
â”œâ”€â”€ Bootloader      (0x1000)
â”œâ”€â”€ Partition Table (0x8000)
â”œâ”€â”€ NVS             (0x9000)  â† åœ¨é€™è£¡ï¼
â”œâ”€â”€ OTA Data        (0xE000)
â””â”€â”€ App (Firmware)  (0x10000)
```

**å¯¦é«”ä½ç½®**ï¼š

- **æ™¶ç‰‡å…§éƒ¨ Flash**ï¼ˆèˆ‡ç¨‹å¼ç¢¼åŒä¸€é¡† ICï¼‰
- **åˆ†å€èµ·å§‹ä½å€**ï¼š0x9000
- **å¤§å°**ï¼šé€šå¸¸ 20KB (0x5000 bytes)
- **ç‰¹æ€§**ï¼šæ–·é›»ä¸æœƒæ¶ˆå¤±ï¼ˆåƒ EEPROMï¼‰

---

## ğŸ“¦ æˆ‘å€‘å„²å­˜äº†ä»€éº¼ï¼Ÿ

### å„²å­˜å…§å®¹

ä½¿ç”¨ ESP32 çš„ `Preferences` åº«ï¼Œå‘½åç©ºé–“ç‚º `"wavplayer"`ï¼š

| éµ (Key)  | é¡å‹ | ç¯„ä¾‹å€¼ | èªªæ˜                |
| --------- | ---- | ------ | ------------------- |
| `track`   | int  | 2      | ç•¶å‰æ›²ç›®ç´¢å¼• (0-31) |
| `volume`  | int  | 30     | éŸ³é‡ (0-100%)       |
| `playing` | bool | false  | æ˜¯å¦æ­£åœ¨æ’­æ”¾        |

### ç¨‹å¼ç¢¼å¯¦ä½œ

```cpp
// å„²å­˜ç‹€æ…‹åˆ° NVS
void savePlaybackState() {
  prefs.begin("wavplayer", false);  // é–‹å•Ÿå‘½åç©ºé–“ï¼ˆå¯å¯«ï¼‰
  prefs.putInt("track", currentTrack);
  prefs.putInt("volume", currentVolume);
  prefs.putBool("playing", playbackState == STATE_PLAYING);
  prefs.end();

  DEBUG_PRINTLN("ğŸ’¾ State saved to NVS");
}

// å¾ NVS è¼‰å…¥ç‹€æ…‹
void loadPlaybackState() {
  prefs.begin("wavplayer", true);  // é–‹å•Ÿå‘½åç©ºé–“ï¼ˆå”¯è®€ï¼‰
  currentTrack = prefs.getInt("track", 0);      // é è¨­å€¼ 0
  currentVolume = prefs.getInt("volume", 30);   // é è¨­å€¼ 30
  bool wasPlaying = prefs.getBool("playing", false);
  prefs.end();

  if (wasPlaying) {
    Serial.println("ğŸ”„ Resuming from last session");
  }
}
```

---

## ğŸ”„ Resume æŒ‡ä»¤çš„ä½œç”¨

### è‡ªå‹• vs æ‰‹å‹•

#### 1ï¸âƒ£ **è‡ªå‹•è¼‰å…¥**ï¼ˆé–‹æ©Ÿæ™‚ï¼‰

ç¨‹å¼åœ¨ `setup()` ä¸­æœƒ**è‡ªå‹•åŸ·è¡Œ**ï¼š

```cpp
void setup() {
  // ...
  loadPlaybackState();  // â† è‡ªå‹•è¼‰å…¥ï¼
  // ...
}
```

**é–‹æ©Ÿæµç¨‹**ï¼š

```
ESP32 å•Ÿå‹•
    â†“
åŸ·è¡Œ setup()
    â†“
loadPlaybackState() â† è‡ªå‹•å¾ NVS è®€å–
    â†“
é¡¯ç¤º: ğŸ”„ Resuming from last session
       Track: 2, Volume: 30%
    â†“
ç¹¼çºŒæ’­æ”¾
```

#### 2ï¸âƒ£ **æ‰‹å‹• Resume**ï¼ˆSerial æŒ‡ä»¤ï¼‰

åœ¨ç¨‹å¼é‹è¡Œä¸­ï¼Œä½ å¯ä»¥æ‰‹å‹•åŸ·è¡Œï¼š

```bash
resume
```

**ä½œç”¨**ï¼š

- é‡æ–°å¾ NVS è®€å–å„²å­˜çš„ç‹€æ…‹
- è¦†è“‹ç•¶å‰çš„ runtime ç‹€æ…‹
- ç”¨æ–¼ã€Œå›åˆ°ä¸Šæ¬¡å„²å­˜çš„ç‹€æ…‹ã€

**ä½¿ç”¨å ´æ™¯ç¯„ä¾‹**ï¼š

```bash
# å ´æ™¯ 1ï¼šæ¸¬è©¦ç”¨
status          # Track: 5, Volume: 50%
save            # å„²å­˜ç•¶å‰ç‹€æ…‹

# ç„¶å¾Œä½ æ‰‹å‹•æ”¹è®Šç‹€æ…‹
(æŒ‰ NEXT å¹¾æ¬¡ï¼ŒéŸ³é‡èª¿åˆ° 80%)
status          # Track: 8, Volume: 80%

resume          # æ¢å¾©åˆ°å„²å­˜çš„ç‹€æ…‹
status          # Track: 5, Volume: 50% (å›åˆ°å‰›æ‰å„²å­˜çš„)

# å ´æ™¯ 2ï¼šæ„å¤–æ”¹è®Šå¾Œæ¢å¾©
(ä¸å°å¿ƒæŒ‰äº†å¾ˆå¤šæ¬¡ NEXT)
resume          # å›åˆ°ä¸Šæ¬¡è‡ªå‹•å„²å­˜çš„ç‹€æ…‹
```

---

## ğŸ” è‡ªå‹•å„²å­˜æ™‚æ©Ÿ

ç³»çµ±æœƒåœ¨ä»¥ä¸‹æƒ…æ³**è‡ªå‹•åŸ·è¡Œ** `savePlaybackState()`ï¼š

### è§¸ç™¼æ¢ä»¶

| äº‹ä»¶                 | å»¶é²     | ä½ç½®                |
| -------------------- | -------- | ------------------- |
| æ›²ç›®æ”¹è®Š (PREV/NEXT) | ç«‹å³     | `buttonHandlerTask` |
| éŸ³é‡æ”¹è®Š (VOL+/-)    | ç«‹å³     | `buttonHandlerTask` |
| æš«åœ/æ’­æ”¾åˆ‡æ›        | ç«‹å³     | `buttonHandlerTask` |
| èƒŒæ™¯å®šæ™‚å™¨           | æ¯ 30 ç§’ | `buttonHandlerTask` |

### ç¨‹å¼ç¢¼ä½ç½®

```cpp
// buttonHandlerTask (Core 0)
void buttonHandlerTask(void* parameter) {
  static unsigned long lastSave = 0;

  while (true) {
    // ... æŒ‰éˆ•è™•ç† ...

    switch (i) {
      case 0: // VOL+
        currentVolume = min(100, currentVolume + 5);
        savePlaybackState();  // â† ç«‹å³å„²å­˜
        break;

      case 3: // NEXT
        currentTrack = (currentTrack + 1) % playlistSize;
        trackChanged = true;
        // åœ¨ audioPlaybackTask ä¸­æœƒåŸ·è¡Œ savePlaybackState()
        break;
    }

    // èƒŒæ™¯è‡ªå‹•å„²å­˜ï¼ˆæ¯ 30 ç§’ï¼‰
    if (millis() - lastSave > 30000) {
      savePlaybackState();  // â† å®šæ™‚å„²å­˜
      lastSave = millis();
    }
  }
}
```

---

## ğŸ’¾ NVS å¯«å…¥æ¬¡æ•¸é™åˆ¶

### Flash å£½å‘½

ESP32 çš„ Flash æœ‰å¯«å…¥æ¬¡æ•¸é™åˆ¶ï¼š

- **ç†è«–å£½å‘½**ï¼š~100,000 æ¬¡å¯«å…¥/æŠ¹é™¤ï¼ˆæ¯å€‹æ‰‡å€ï¼‰
- **å¯¦éš›å£½å‘½**ï¼šé€šå¸¸æ›´é«˜ï¼ˆ150,000+ï¼‰

### æˆ‘å€‘çš„ä½¿ç”¨æƒ…æ³

**æ¯æ—¥ä¼°ç®—**ï¼š

```
å‡è¨­æ¯å¤©ä½¿ç”¨ 8 å°æ™‚
- èƒŒæ™¯å„²å­˜ï¼š8å°æ™‚ * 2æ¬¡/åˆ†é˜ = 960æ¬¡/å¤©
- æ›æ›²å„²å­˜ï¼šå¹³å‡ 50æ¬¡/å¤©
- éŸ³é‡èª¿æ•´ï¼šå¹³å‡ 20æ¬¡/å¤©
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½è¨ˆï¼š~1,030 æ¬¡/å¤©
```

**å£½å‘½è¨ˆç®—**ï¼š

```
100,000 æ¬¡ Ã· 1,030 æ¬¡/å¤© = 97 å¤©
```

### ğŸ˜± æœƒä¸æœƒå¤ªå¿«å£æ‰ï¼Ÿ

**ä¸æœƒï¼** åŸå› ï¼š

1. **Wear Leveling**ï¼ˆç£¨æå¹³è¡¡ï¼‰
   - ESP32 çš„ NVS ç³»çµ±è‡ªå‹•åˆ†æ•£å¯«å…¥
   - ä¸æœƒç¸½æ˜¯å¯«åŒä¸€å€‹ä½ç½®
2. **å¯¦éš›å£½å‘½æ›´é•·**

   - Flash å¯¦éš›å¯æ‰¿å—æ›´å¤šæ¬¡æ•¸
   - é€šå¸¸å¯ç”¨ 1-2 å¹´

3. **å„ªåŒ–å»ºè­°**

å¦‚æœæ“”å¿ƒå£½å‘½ï¼Œå¯ä»¥èª¿æ•´èƒŒæ™¯å„²å­˜é »ç‡ï¼š

```cpp
// æ”¹ç‚º 5 åˆ†é˜å„²å­˜ä¸€æ¬¡
if (millis() - lastSave > 300000) {  // 300ç§’ = 5åˆ†é˜
  savePlaybackState();
  lastSave = millis();
}
```

é€™æ¨£å£½å‘½å»¶é•·åˆ°ï¼š

```
100,000 Ã· (8*12 + 70) = 100,000 Ã· 166 = 602 å¤© (1.6å¹´)
```

---

## ğŸ” æŸ¥çœ‹ NVS å…§å®¹

### ä½¿ç”¨ `nvs` æŒ‡ä»¤

```bash
nvs

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         NVS Storage (Flash)            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¾ Stored Preferences:
  Track Index:   2           â† Flash ä¸­å„²å­˜çš„
  Track File:    /song3.wav
  Volume:        30%
  Was Playing:   No

ğŸ“‹ Current Runtime State:
  Track Index:   5           â† RAM ä¸­é‹è¡Œçš„
  Track File:    /song6.wav
  Volume:        50%
  State:         Playing

âš™ï¸  NVS Operations:
  Auto-save triggers:
    - Track change
    - Volume change
    - Pause/Play toggle
    - Every 30 seconds (background)
```

**è§£è®€**ï¼š

- **Stored Preferences** = Flash ä¸­æ°¸ä¹…å„²å­˜çš„å€¼
- **Current Runtime State** = RAM ä¸­ç•¶å‰é‹è¡Œçš„å€¼
- å¦‚æœå…©è€…ä¸åŒï¼Œè¡¨ç¤ºé‚„æ²’å„²å­˜ï¼Œæˆ–åŸ·è¡Œ `resume` æœƒå›åˆ° Stored ç‹€æ…‹

---

## ğŸ—‘ï¸ æ¸…é™¤ NVSï¼ˆé‡ç½®ï¼‰

å¦‚æœæƒ³æ¸…é™¤æ‰€æœ‰å„²å­˜è³‡æ–™ï¼š

### æ–¹æ³• 1ï¼šç¨‹å¼ç¢¼æ¸…é™¤

åœ¨ Serial ä¸­å¯ä»¥åŠ å…¥æ¸…é™¤æŒ‡ä»¤ï¼ˆç›®å‰æœªå¯¦ä½œï¼‰ï¼š

```cpp
// å¯ä»¥åŠ å…¥é€™å€‹æŒ‡ä»¤
else if (cmd == "clear" || cmd == "reset") {
  prefs.begin("wavplayer", false);
  prefs.clear();  // æ¸…é™¤æ‰€æœ‰ key
  prefs.end();
  Serial.println("âœ… NVS cleared");
}
```

### æ–¹æ³• 2ï¼šæ‰‹å‹•æŠ¹é™¤ï¼ˆesptoolï¼‰

```bash
esptool.py --port /dev/cu.usbserial-1140 erase_region 0x9000 0x5000
```

### æ–¹æ³• 3ï¼šé‡åˆ· Partition Table

å®Œæ•´é‡åˆ·éŸŒé«”æœƒé‡ç½® NVSã€‚

---

## ğŸ“Š NVS vs å…¶ä»–å„²å­˜æ–¹å¼

| æ–¹å¼                | ä½ç½®       | å¤§å°  | é€Ÿåº¦ | æ–·é›»ä¿å­˜ | å¯«å…¥æ¬¡æ•¸ |
| ------------------- | ---------- | ----- | ---- | -------- | -------- |
| **NVS**             | Flash      | 20KB  | ä¸­ç­‰ | âœ… æ˜¯    | ~100K    |
| **SPIFFS/LittleFS** | Flash      | è‡ªè¨‚  | æ…¢   | âœ… æ˜¯    | ~100K    |
| **SD Card**         | å¤–éƒ¨       | GB ç´š | æ…¢   | âœ… æ˜¯    | æ¥µé«˜     |
| **RAM**             | å…§éƒ¨ SRAM  | 320KB | æ¥µå¿« | âŒ å¦    | ç„¡é™     |
| **EEPROM**          | (ESP32 ç„¡) | -     | -    | -        | -        |

**ç‚ºä»€éº¼é¸ NVSï¼Ÿ**

- âœ… æ–·é›»ä¿å­˜
- âœ… å¿«é€Ÿè®€å¯«
- âœ… å…§å»ºæ”¯æ´ï¼ˆç„¡éœ€å¤–éƒ¨ç¡¬é«”ï¼‰
- âœ… ESP32 å®˜æ–¹æ¨è–¦
- âœ… è‡ªå‹• wear leveling

---

## ğŸ§ª å¯¦é©—æ¸¬è©¦

### æ¸¬è©¦ 1ï¼šé©—è­‰æ–·é›»ä¿å­˜

```bash
# 1. è¨­å®šç‹€æ…‹
(æŒ‰ NEXT åˆ° Track 3, éŸ³é‡èª¿åˆ° 40%)
save

# 2. æŸ¥çœ‹å„²å­˜
nvs
# æ‡‰è©²é¡¯ç¤º Track: 3, Volume: 40%

# 3. æ–·é›»é‡å•Ÿ
(æ‹”é›»æºï¼Œå†æ’å›)

# 4. æŸ¥çœ‹å•Ÿå‹•è¨Šæ¯
# æ‡‰è©²çœ‹åˆ°ï¼š
# ğŸ”„ Resuming from last session
#    Track: 3, Volume: 40%
```

### æ¸¬è©¦ 2ï¼šResume æŒ‡ä»¤

```bash
# 1. å„²å­˜ç•¶å‰ç‹€æ…‹
status  # Track: 2
save

# 2. æ”¹è®Šç‹€æ…‹
(æŒ‰ NEXT NEXT NEXT)
status  # Track: 5

# 3. åŸ·è¡Œ resume
resume

# 4. ç¢ºèªæ¢å¾©
status  # Track: 2 (æ¢å¾©äº†ï¼)
```

---

## ğŸ¯ ç¸½çµ

### Resume æŒ‡ä»¤

- **ä½œç”¨**ï¼šå¾ NVS è®€å–ä¸Šæ¬¡å„²å­˜çš„æ’­æ”¾ç‹€æ…‹
- **ä½¿ç”¨æ™‚æ©Ÿ**ï¼šæƒ³æ¢å¾©åˆ°ä¹‹å‰å„²å­˜çš„ç‹€æ…‹æ™‚
- **æ•ˆæœ**ï¼šè¦†è“‹ç•¶å‰ RAM ä¸­çš„ç‹€æ…‹

### NVS å„²å­˜ä½ç½®

- **å¯¦é«”ä½ç½®**ï¼šESP32 Flash æ™¶ç‰‡å…§éƒ¨ï¼ˆ0x9000ï¼‰
- **é‚è¼¯ä½ç½®**ï¼šå‘½åç©ºé–“ "wavplayer"
- **å„²å­˜å…§å®¹**ï¼štrack, volume, playing (å…± 3 å€‹éµå€¼å°)
- **å£½å‘½**ï¼šç´„ 100,000 æ¬¡å¯«å…¥

### å·¥ä½œæµç¨‹

```
é–‹æ©Ÿ
  â†“
è‡ªå‹• loadPlaybackState() â† å¾ NVS è®€å–
  â†“
æ­£å¸¸ä½¿ç”¨ï¼ˆæ”¹è®ŠéŸ³é‡ã€æ›²ç›®ç­‰ï¼‰
  â†“
è‡ªå‹• savePlaybackState() â† å¯«å…¥ NVS
  â†“
æ–·é›»
  â†“
é‡æ–°é–‹æ©Ÿ
  â†“
è‡ªå‹•æ¢å¾©åˆ°ä¸Šæ¬¡ç‹€æ…‹ âœ…
```

**æ‰‹å‹•ä»‹å…¥**ï¼š

```
æ­£åœ¨æ’­æ”¾ Track 5
  â†“
è¼¸å…¥ "resume"
  â†“
æ¢å¾©åˆ° NVS ä¸­å„²å­˜çš„ç‹€æ…‹ï¼ˆä¾‹å¦‚ Track 2ï¼‰
```

ç°¡å–®ä¾†èªªï¼š**NVS å°±åƒæ˜¯ ESP32 çš„ã€Œå­˜æª”é»ã€ï¼Œresume å°±æ˜¯ã€Œè®€å–å­˜æª”ã€ï¼** ğŸ®

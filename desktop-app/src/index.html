<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ESP32 Music Center</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  </head>
  <body>
    <!-- Settings Modal -->
    <div id="settings-overlay" class="overlay" style="display: none">
      <div class="modal">
        <h2>Audio Settings</h2>
        <label>Buffer Size (bytes)</label>
        <select id="cfg-buf-size">
          <option value="4096">4096 (Low Latency)</option>
          <option value="8192">8192 (Balanced)</option>
          <option value="16384">16384 (Stable)</option>
        </select>

        <label>Max Tracks</label>
        <input type="number" id="cfg-max-tracks" value="255" />

        <div class="modal-actions">
          <button onclick="closeSettings()">Cancel</button>
          <button class="primary" onclick="saveSettings()">
            Save & Reboot
          </button>
        </div>
      </div>
    </div>

    <div id="connection-overlay" class="overlay">
      <div class="modal">
        <h2>Select Device</h2>
        <p style="color: #888">Please connect your ESP32 Music Center</p>
        <select id="port-selector"></select>
        <button class="primary" onclick="connectDevice()">Connect</button>
        <button onclick="scanPorts()">Rescan</button>
      </div>
    </div>

    <div id="upload-overlay" class="overlay" style="display: none">
      <div class="modal" style="width: 400px">
        <h3>Uploading...</h3>
        <p
          id="upload-filename"
          style="margin-bottom: 5px; color: var(--accent-color)"
        >
          song.mp3
        </p>
        <div
          style="
            background: #444;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
          "
        >
          <div
            id="upload-bar"
            style="background: var(--accent-color); width: 0%; height: 100%"
          ></div>
        </div>
        <p id="upload-percent">0%</p>
      </div>
    </div>

    <!-- Startup Splash -->
    <div id="startup-splash" style="
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background: #0a0a0f; 
        z-index: 9999; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        flex-direction: column;
        transition: opacity 0.5s ease;
    ">
        <div style="font-size: 64px; animation: bounce 1s infinite;">üéµ</div>
        <h1 style="color: white; margin-top: 20px; font-weight: 300;">ESP32 Hi-Fi DAP</h1>
    </div>

    <div id="sidebar">
      <h3 style="margin-left: 10px; margin-bottom: 20px">ESP32 Music Center</h3>

      <!-- Nav -->
      <button
        class="nav-btn active"
        onclick="switchView('library')"
        id="nav-library"
      >
        <span>üéµ</span> Library
      </button>
      <button class="nav-btn" onclick="switchView('upload')" id="nav-upload">
        <span>üì§</span> Upload
      </button>
      <button class="nav-btn" onclick="switchView('diagnostics')" id="nav-diagnostics">
        <span>üìä</span> Diagnostics
      </button>

      <div style="flex-grow: 1"></div>

      <div class="status-card">
        <div class="status-row">
          <span>State:</span> <span id="status-state">--</span>
        </div>
        <div class="status-row">
          <span>Track:</span> <span id="status-track">--</span>
        </div>
        <div class="status-row">
          <span>Volume:</span> <span id="status-vol">--</span>
        </div>
      </div>
      <div class="status-card">
        <div class="status-row">
          <span>Heap:</span> <span id="sys-heap">--</span>
        </div>
        <div class="status-row">
          <span>Uptime:</span> <span id="sys-uptime">--</span>
        </div>
        
        <!-- SD Storage Section -->
        <div style="margin-top: 12px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              font-size: 11px;
              color: #888;
              margin-bottom: 4px;
            "
          >
            <span>Storage</span>
            <span id="sd-text" style="color: var(--text-primary)">--</span>
          </div>
          <div class="sd-bar-container">
            <div id="sd-bar-fill" class="sd-bar-fill"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="main">
      <div id="header">
        <span id="device-info">Disconnected</span>
        <div class="toolbar">
          <button onclick="refreshLibrary()">üîÑ Refresh</button>
          <button onclick="openSettings()">‚öôÔ∏è Settings</button>
        </div>
      </div>

      <!-- View: Library -->
      <div id="view-library" class="view-section active">
        <ul id="file-list">
          <!-- Tracks injected here -->
        </ul>
        <!-- Refresh moved to header -->
      </div>

      <!-- View: Upload -->
      <div id="view-upload" class="view-section">
        <div
          class="upload-zone"
          id="drop-zone"
          onclick="document.getElementById('file-input').click()"
        >
          <h1 style="font-size: 48px; margin: 0">üì§</h1>
          <h2>Upload Music</h2>
          <p>Drag MP3/WAV files here or click to browse</p>
          <button class="primary" style="font-size: 16px; padding: 12px 24px">
            Select File
          </button>
          <input
            type="file"
            id="file-input"
            style="display: none"
            accept=".mp3,.wav"
            onchange="handleFileSelect(this)"
          />
        </div>

        <div id="upload-status-box" style="margin: 0 40px 40px; display: none">
          <h3 id="upload-filename-embedded" style="color: var(--accent-color)">
            Uploading...
          </h3>
          <div
            style="
              background: #444;
              height: 12px;
              border-radius: 6px;
              overflow: hidden;
              margin: 10px 0;
            "
          >
            <div
              id="upload-bar-embedded"
              style="background: var(--accent-color); width: 0%; height: 100%"
            ></div>
          </div>
          <p
            id="upload-percent-embedded"
            style="text-align: right; color: #888"
          >
            0%
          </p>
        </div>
      </div>

      <!-- View: Diagnostics -->
      <div id="view-diagnostics" class="view-section">
          <!-- System Bar (Top) -->
          <div class="system-bar">
             <div class="sys-item">
                 <span>CPU0</span>
                 <span id="sys-cpu0" class="sys-val">--%</span>
             </div>
             <div class="sys-item">
                 <span>CPU1</span>
                 <span id="sys-cpu1" class="sys-val">--%</span>
             </div>
             <div class="sys-item">
                 <span>HEAP</span>
                 <span id="sys-heap-bar" class="sys-val">--</span>
             </div>
             <div class="sys-item">
                 <span>PSRAM</span>
                 <span id="sys-psram-bar" class="sys-val">--</span>
             </div>
             <div class="sys-item">
                 <span>UPTIME</span>
                 <span id="sys-uptime-bar" class="sys-val">--</span>
             </div>
          </div>
          
          <div style="padding: 0 24px 24px; height: 100%; overflow: hidden; display: flex; flex-direction: column;">
              <!-- Charts -->
              <div style="display: flex; gap: 16px; margin-bottom: 20px; height: 140px; flex-shrink: 0;">
                  <div class="glass-panel" style="flex: 1; padding: 12px; display: flex; flex-direction: column;">
                      <h4 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Audio Task CPU %</h4>
                      <canvas id="chart-cpu" width="300" height="100" style="width: 100%; height: 100%;"></canvas>
                  </div>
                  <div class="glass-panel" style="flex: 1; padding: 12px; display: flex; flex-direction: column;">
                      <h4 style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Free Heap (KB)</h4>
                      <canvas id="chart-heap" width="300" height="100" style="width: 100%; height: 100%;"></canvas>
                  </div>
              </div>
              
              <!-- Toolbar -->
              <div style="display: flex; justify-content: flex-end; margin-bottom: 8px;">
                  <label class="toggle-switch">
                      <input type="checkbox" id="engineer-mode-toggle" onchange="toggleEngineerMode(this.checked)">
                      <span class="slider"></span>
                      <span class="label-text">Engineer Mode</span>
                  </label>
              </div>
              
              <!-- Table -->
              <div class="diag-table-container">
                  <table class="diag-table">
                      <thead>
                          <tr>
                              <th>ID</th>
                              <th>TASK NAME</th>
                              <th>STATE</th>
                              <th>PRIO</th>
                              <th>STACK (MIN FREE)</th>
                              <th>CPU % (PER CORE)</th>
                              <th class="col-eng" style="display: none;">CORE</th>
                              <th class="col-eng" style="display: none;">HWM</th>
                          </tr>
                      </thead>
                      <tbody id="diag-table-body">
                          <!-- Tasks injected here -->
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <div id="player-bar">
        <!-- Progress Bar -->
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>

        <!-- Now Playing Section -->
        <div>
          <div class="track-info-container">
            <div id="now-playing-title">No Track Selected</div>
            <div id="now-playing-time">--:--</div>
          </div>
        </div>

        <!-- Controls Section -->
        <div class="controls">
          <button class="control-btn" id="btn-loop" onclick="toggleLoop()" title="Loop Mode">üîÅ</button>
          <button class="control-btn" onclick="sendCmd('prev')" title="Previous">‚èÆ</button>
          <button class="control-btn" id="btn-play" onclick="togglePlay()" title="Play/Pause">‚ñ∂</button>
          <button class="control-btn" onclick="sendCmd('next')" title="Next">‚è≠</button>
        </div>

        <!-- Volume Section -->
        <div class="volume-control">
          <span id="vol-icon" onclick="toggleMute()">üîä</span>
          <input 
            type="range" 
            id="vol-slider" 
            min="0" 
            max="100" 
            value="0" 
            oninput="handleVolumeInput(this.value)"
            onchange="handleVolumeChange(this.value)"
          />
          <span id="vol-display" style="min-width: 35px">--</span>
        </div>
      </div>
    </div>

    <script src="renderer.js"></script>
  </body>
</html>
